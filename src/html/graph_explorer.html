<!doctype html>
<html>

  <head>

    <title>Viz test</title>
    <link href="https://fonts.googleapis.com/css?family=Inconsolata|Open+Sans" rel="stylesheet">

    <style type="text/css">

      html, body                          { height: 100%; width: 100%; max-width: 100%; margin: 0; padding: 0; border: 0; overflow: hidden; }
      html, body, #error_range            { font-family: "open sans", sans-serif; }

      #topbox                             { height: 100%; width: 100%; margin: 0; padding: 0; border-collapse: collapse; border: 0; table-layout: fixed; }

      .hideError #topbox                  { bottom: 0; }

      #textrow                            { }
      #textrow td                         { border-top  : 1px solid #ddd; background-color: #eee; }
      #textrow textarea                   { resize: none; }

      #edit_row td                        { height: 100%; }

      #svg_host                           { width: 70%; text-align: center; position: relative; overflow: auto; }
      #svg_target                         { width: 100%; height: 100%; position: absolute; top: 0; left: 0; }
      #svg_host svg                       { position: absolute; top: 0; left: 0; height: 100%; width: 100%; }
      #editor_target                      { width: 30%; }

      #widget_target                      { width: 60px; border: solid #ddd; border-width: 0 1px; background-color: #f8f8f8;
                                            box-sizing: border-box; padding: 0.5em 5px; vertical-align: bottom; }

      #widget_target input[type="button"] { border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; display: block;
                                            height: 40px; width: 40px; line-height: 40px; margin: 0 auto; padding: 0; }

      #widget_target input[type="button"]+
                     input[type="button"] { margin-top: 0.2em; }

      #widget_target input[type="number"] { width: 70%; margin: 0 auto 0 auto; display: block; letter-spacing: -0.1em; font-size: 70%; }
      .small_label                        { font-size: 90%; text-align: center; }

      #editor                             { font-family: "inconsolata", monospace; height: 100%; width: 100%;
                                            box-sizing: border-box; margin: 0; padding: 0 0 0 0.5em; border: 0; }

      #error_range                        { padding: 0.25em 0.5em; margin: 0; border: 0; color: #b00; background-color: #fdd; }

      .hideError #error_range             { display: none; }

    </style>

    <script defer type="text/javascript" src="jssm.es5.cjs.min.js"></script>
    <script defer type="text/javascript" src="jssm-viz.es5.cjs.js"></script>
    <script defer type="text/javascript" src="ace.js"></script>

    <script defer type="text/javascript">

      window.onload = () => {



        const jssm     = require('jssm'),
              sm       = jssm.sm,
              jviz     = require('jssm-viz'),
              byId     = z => document.getElementById(z);

        const svg_t    = byId('svg_target'),
              editor   = byId('editor'),
              errorX   = byId('error_range'),
              graphRot = byId('graphRot'),
              textUp   = byId('textUp'),
              textDown = byId('textDown'),
              zoom     = byId('zoom');

        const minSz  = 3;
        let   edSize = 21;



        const updateEditor = () => {
          editor.style.fontSize = `${edSize}px`;
        };



        const bumpTsUp = () => {
          edSize += 1;
          updateEditor();
        };



        const bumpTsDown = () => {
          edSize = Math.max(edSize - 1, minSz);
          updateEditor();
        };



        const updateVisual = (config) => {

          const machine = sm`${config}`;
          svg_t.innerHTML = jviz.dot_to_svg(jviz.dot(machine), { engine: machine.graph_layout() || 'dot' });

        };



        var was = '';
        const updateCode = () => {

          try {

            const val = ace_editor.getValue();
            if (val === was) { return; }

            const newConfig = val;
            updateVisual(newConfig);

            errorX.innerHTML = '';
            document.body.classList.toggle('hideError', true);

          } catch (e) {

            if (e.message) {

              errorX.innerHTML = e.message;

            } else {

              const start_r = `${e.location.start.line}:${e.location.start.column}`,
                    end_r   = `${e.location.end.line}:${e.location.end.column}`;

              errorX.innerHTML = (start_r === end_r) ? `${e.message} (${start_r})`
                                                     : `${e.message} (${start_r}&rarr;${end_r})`;
            }

            document.body.classList.toggle('hideError', false);

          }

          was = editor.value;
          updateEditor();

        }



        const graphRotate = () => {

          // todo whargarbl comeback fixme
          // this is implemented in a really gross way in jssm-viz right now
          // remove this once fixed there; this should be a language feature

          window.lrGViz = (!(window.lrGViz)); // graph checks this before issuing the internal instruction :/
          was = false;
          updateCode();

        };



        const setZoom = () => {

          const newZoom = Math.max(1, byId('zoom').value);

          byId('svg_target').style.width  = `${newZoom}%`;
          byId('svg_target').style.height = `${newZoom}%`;

        };



        textDown.onclick = bumpTsDown;
        textUp.onclick   = bumpTsUp;
        graphRot.onclick = graphRotate;
        zoom.oninput     = setZoom;



        const l_config = `
machine_name     : "Example traffic light";
machine_author   : "John Haugeland <stonecypher@gmail.com>";
machine_license  : MIT;
machine_comment  : "Just a quick example of how these are written";
machine_language : en;
machine_version  : 1.0.0;
fsl_version      : 1.0.0;

start_states     : [Off Red];





Off 'Enable' -> Red;

Red 'Proceed' => Green 'Proceed' => Yellow 'Proceed' => Red;

[Red Yellow Green] ~> Off;`.trim();



        editor.innerHTML = l_config;
        editor.onkeyup   = () => updateCode();

        var ace_editor = ace.edit("editor");
        ace_editor.setTheme("ace/theme/solarized_dark");
        ace_editor.session.setMode("ace/mode/fsl");

        updateVisual(l_config);
        updateCode();



      }

    </script>


  </head>

  <body class="hideError">

    <table id="topbox">

      <tr id="edit_row">
        <td id="svg_host"><div id="svg_target"></div></td>
        <td id="widget_target">
          <div class="small_label">Zoom</div>
          <input id="zoom"     type="number" min="0" step="10" value="100"/><br/>
          <input id="graphRot" type="button" value="&#8635;"/><br/>
          <input id="textUp"   type="button" value="T &uarr;"/>
          <input id="textDown" type="button" value="T &darr;"/><br/>
          <input id="popPng"   type="button" value="PNG"/>
          <input id="popSvg"   type="button" value="SVG"/>
          <input id="popDot"   type="button" value="DOT"/>
        </td>
        <td id="editor_target"><pre id="editor"></pre></td>
      </tr>

      <tr><td colspan="3" id="error_range"></td></tr>

    </table>

    <div id="textrow"></div>

  </body>

</html>